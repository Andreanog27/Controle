{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="container mt-4">
    <h2 class="fw-bold mb-4">Dashboard Financeiro</h2>

    <!-- Cards Resumo -->
    <div class="row g-4 mb-4">

        <!-- Total de Gastos -->
        <div class="col-md-6 col-lg-3">
            <div class="card p-4 bg-danger text-white shadow summary-card">
                <h5 class="card-title fw-bold">Total de Gastos</h5>
                <p class="card-text fs-3">R$ {{ total_gastos }}</p>
            </div>
        </div>

        <!-- Total Recebido -->
        <div class="col-md-6 col-lg-3">
            <div class="card p-4 bg-success text-white shadow summary-card">
                <h5 class="card-title fw-bold">Total Recebido</h5>
                <p class="card-text fs-3">R$ {{ total_receitas }}</p>
            </div>
        </div>

        <!-- Saldo -->
        <div class="col-md-6 col-lg-3">
            <div class="card p-4 {% if saldo >= 0 %}bg-primary text-white{% else %}bg-danger text-white{% endif %} shadow summary-card">
                <h5 class="card-title fw-bold">Saldo</h5>
                <p class="card-text fs-3">R$ {{ saldo }}</p>
            </div>
        </div>

        <!-- Média Mensal -->
        <div class="col-md-6 col-lg-3">
            <div class="card p-4 bg-dark text-white shadow summary-card">
                <h5 class="card-title fw-bold">Média Mensal</h5>
                <p class="card-text fs-3">R$ {{ media_mensal|floatformat:2 }}</p>
            </div>
        </div>

    </div>

    <!-- Gráficos -->
    <div class="row g-4">

        <!-- Gráfico de Gastos Mensais -->
        <div class="col-md-6">
            <div class="card p-4 shadow">
                <h5 class="card-title mb-4 fw-bold">Gastos Mensais</h5>
                <canvas id="gastosMensaisChart"></canvas>
            </div>
        </div>

        <!-- Gráfico de Receitas Mensais -->
        <div class="col-md-6">
            <div class="card p-4 shadow">
                <h5 class="card-title mb-4 fw-bold">Receitas Mensais</h5>
                <canvas id="receitasMensaisChart"></canvas>
            </div>
        </div>

        <!-- Gráfico por Categoria -->
        <div class="col-md-12">
            <div class="card p-4 shadow">
                <h5 class="card-title mb-4 fw-bold">Gastos por Categoria</h5>
                <canvas id="categoriasChart"></canvas>
            </div>
        </div>

    </div>

    <!-- ===================================== -->
    <!-- LISTA DE RECEITAS (COM EXCLUSÃO)      -->
    <!-- ===================================== -->
    <h3 class="mt-5 fw-bold">Receitas Recentes</h3>
    <div class="row g-4">
        {% for rec in receitas %}
        <div class="col-md-6 col-lg-4">
            <div class="card p-4 shadow-sm">

                <div class="d-flex justify-content-between align-items-start">
                    <h5 class="card-title fw-bold">{{ rec.descricao }}</h5>

                    <a href="#" class="text-danger fs-4" data-bs-toggle="modal" data-bs-target="#deleteReceita{{ rec.id }}">
                        <i class="bi bi-trash-fill"></i>
                    </a>
                </div>

                <p class="card-text fs-5">R$ {{ rec.valor }}</p>
                <p class="card-text text-muted"><small>{{ rec.data|date:"d/m/Y" }}</small></p>

                <!-- Modal -->
                <div class="modal fade" id="deleteReceita{{ rec.id }}" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">

                            <div class="modal-header">
                                <h5 class="modal-title">Excluir Receita</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>

                            <div class="modal-body">
                                Tem certeza que deseja excluir <strong>{{ rec.descricao }}</strong>?
                            </div>

                            <div class="modal-footer">
                                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>

                                <form method="post" action="{% url 'excluir_receita' rec.id %}">
                                    {% csrf_token %}
                                    <button class="btn btn-danger">Excluir</button>
                                </form>

                            </div>

                        </div>
                    </div>
                </div>

            </div>
        </div>
        {% empty %}
        <p class="text-muted">Nenhuma receita cadastrada.</p>
        {% endfor %}
    </div>

    <!-- ===================================== -->
    <!-- LISTA DE DESPESAS (COM EXCLUSÃO)      -->
    <!-- ===================================== -->
    <h3 class="mt-5 fw-bold">Despesas Recentes</h3>
    <div class="row g-4">
        {% for desp in despesas %}
        <div class="col-md-6 col-lg-4">
            <div class="card p-4 shadow-sm">

                <div class="d-flex justify-content-between align-items-start">
                    <h5 class="card-title fw-bold">{{ desp.descricao }}</h5>

                    <a href="#" class="text-danger fs-4" data-bs-toggle="modal" data-bs-target="#deleteDespesa{{ desp.id }}">
                        <i class="bi bi-trash-fill"></i>
                    </a>
                </div>

                <p class="card-text fs-5">R$ {{ desp.valor }}</p>
                <p class="card-text text-muted"><small>{{ desp.data|date:"d/m/Y" }}</small></p>

                <!-- Modal -->
                <div class="modal fade" id="deleteDespesa{{ desp.id }}" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">

                            <div class="modal-header">
                                <h5 class="modal-title">Excluir Despesa</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>

                            <div class="modal-body">
                                Tem certeza que deseja excluir <strong>{{ desp.descricao }}</strong>?
                            </div>

                            <div class="modal-footer">
                                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>

                                <form method="post" action="{% url 'excluir_despesa' desp.id %}">
                                    {% csrf_token %}
                                    <button class="btn btn-danger">Excluir</button>
                                </form>

                            </div>

                        </div>
                    </div>
                </div>

            </div>
        </div>
        {% empty %}
        <p class="text-muted">Nenhuma despesa cadastrada.</p>
        {% endfor %}
    </div>

</div>

<!-- JSON Scripts -->
{{ valores_gastos|json_script:"valores-gastos-data" }}
{{ valores_receitas|json_script:"valores-receitas-data" }}
{{ categorias_labels|json_script:"categorias-labels-data" }}
{{ categorias_valores|json_script:"categorias-valores-data" }}
{{ meses|json_script:"meses-data" }}

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const meses = JSON.parse(document.getElementById('meses-data').textContent);
const valoresGastos = JSON.parse(document.getElementById('valores-gastos-data').textContent);
const valoresReceitas = JSON.parse(document.getElementById('valores-receitas-data').textContent);
const categoriasLabels = JSON.parse(document.getElementById('categorias-labels-data').textContent);
const categoriasValores = JSON.parse(document.getElementById('categorias-valores-data').textContent);

// Gastos
new Chart(document.getElementById('gastosMensaisChart'), {
    type: 'line',
    data: {
        labels: meses,
        datasets: [{
            label: 'Gastos',
            data: valoresGastos,
            backgroundColor: 'rgba(255, 99, 132, 0.3)',
            borderColor: 'rgba(255, 0, 80, 1)',
            borderWidth: 3,
            fill: true,
            tension: 0.3
        }]
    },
    options: { scales: { y: { beginAtZero: true } } }
});

// Receitas
new Chart(document.getElementById('receitasMensaisChart'), {
    type: 'line',
    data: {
        labels: meses,
        datasets: [{
            label: 'Receitas',
            data: valoresReceitas,
            backgroundColor: 'rgba(0, 255, 127, 0.3)',
            borderColor: 'rgba(0, 200, 100, 1)',
            borderWidth: 3,
            fill: true,
            tension: 0.3
        }]
    },
    options: { scales: { y: { beginAtZero: true } } }
});

// Categoria
new Chart(document.getElementById('categoriasChart'), {
    type: 'bar',
    data: {
        labels: categoriasLabels,
        datasets: [{
            label: 'Gastos',
            data: categoriasValores,
            backgroundColor: 'rgba(54, 162, 235, 0.3)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 2
        }]
    },
    options: { scales: { y: { beginAtZero: true } } }
});
</script>

{% endblock %}
